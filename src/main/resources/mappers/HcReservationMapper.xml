<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thehyundai.thepet.domain.heendycar.HcReservationMapper">

    <insert id="saveReservation" parameterType="HcReservationVO" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO HEENDY_CAR_RESERVATION
        (
            BRANCH_CODE,
            MEMBER_ID,
            RESERVATION_TIME,
            CREATED_AT,
            SERIAL_NUMBER
        )
        SELECT
            '101',
            'M000004',
            TO_DATE('2023-09-24 16:00:00', 'YYYY-MM-DD HH24:MI:SS'),
            TO_DATE('2023-09-24 07:22:14', 'YYYY-MM-DD HH24:MI:SS'),
            h.serial_number
        FROM
            HEENDY_CAR h
        WHERE
            h.BRANCH_CODE = '101'           -- 특정 branch_code에 해당하는 Heendy_car를 선택
          AND NOT EXISTS (
            SELECT 1
            FROM HEENDY_CAR_RESERVATION r
            WHERE r.serial_number = h.serial_number
              AND (r.return_yn = 'N' OR r.cancel_yn = 'N') -- return_yn이 'N'이거나 cancel_yn이 'N'인 것을 제외
        )
          AND ROWNUM = 1;
    </insert>

    <select id="findReservationById" resultType="HcReservationVO">
        SELECT ID,
               BRANCH_CODE,
               MEMBER_ID,
               RESERVATION_TIME,
               CREATED_AT,
               PICKUP_YN,
               CANCEL_YN,
               RETURN_YN
        FROM HEENDY_CAR_RESERVATION
        WHERE ID = #{reservationId}
    </select>

    <update id="updateReservation" parameterType="HcReservationVO">
        UPDATE HEENDY_CAR_RESERVATION
            SET CANCEL_YN = #{cancelYn}
        WHERE ID = #{id}
    </update>

    <select id="findBranchReservation" parameterType="String" resultType="HcReservationVO">
        SELECT r.id,r.member_id,r.serial_number, m.name, m.phone_number, r.reservation_time, r.pickup_yn, r.cancel_yn, r.return_yn
        FROM HEENDY_CAR_RESERVATION r
        JOIN MEMBER m ON r.member_id = m.id
        WHERE r.branch_code = #{branchCode}

    </select>


    <select id="showAllMyReservations" parameterType="String">
        SELECT r.ID,
               r.RESERVATION_TIME,
               r.CREATED_AT,
               r.BRANCH_CODE,
               r.CANCEL_YN,
               b.IMG_URL AS branchImgUrl
        FROM HEENDY_CAR_RESERVATION r
        JOIN BRANCH_HEENDY_CAR b
            ON r.BRANCH_CODE = b.BRANCH_CODE
        WHERE r.MEMBER_ID = #{memberId}
        ORDER BY r.RESERVATION_TIME desc
    </select>

    <update id="cancelReservation" parameterType="String">
        UPDATE HEENDY_CAR_RESERVATION
        SET CANCEL_YN = 'Y'
        WHERE ID = #{reservationId}
    </update>

    <select id="findPresentReservation" parameterType="String" resultType="HcReservationVO">
        SELECT ID,
               BRANCH_CODE,
               MEMBER_ID,
               RESERVATION_TIME
        FROM HEENDY_CAR_RESERVATION
        WHERE MEMBER_ID = #{memberId}
          AND TRUNC(RESERVATION_TIME) = TRUNC(SYSDATE)
          AND CANCEL_YN = 'N'
    </select>


    <update id="changePickUp" parameterType="HcReservationVO">
        UPDATE HEENDY_CAR_RESERVATION
        SET PICKUP_YN = #{pickupYn}
        WHERE ID = #{id}
    </update>

    <update id="changeCancel" parameterType="HcReservationVO">
        UPDATE HEENDY_CAR_RESERVATION
        SET CANCEL_YN = #{cancelYn}
        WHERE ID = #{id}
    </update>

    <update id="changeReturn" parameterType="HcReservationVO">
        UPDATE HEENDY_CAR_RESERVATION
        SET RETURN_YN = #{returnYn}
        WHERE ID = #{id}
    </update>
</mapper>